<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FinTrack – Profile</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <nav class="navbar">
    <div class="nav-brand">
      <div class="logo">FT</div>
      <span>FinTrack</span>
    </div>
    <div class="nav-links">
      <a href="dashboard.html">Dashboard</a>
      <a href="expenses.html">Expenses</a>
      <a href="reports.html">Reports</a>
      <a href="categories.html">Categories</a>
      <a href="profile.html" class="active">Profile</a>
      <a href="admin-dashboard.html" id="adminLink" style="display: none; background: #f59e0b; color: white;">⚙️ Admin Panel</a>
      <button id="logoutBtn" class="btn-secondary" style="margin-left: auto;">Logout</button>
    </div>
  </nav>

  <main class="container">
    <h1>Profile Settings</h1>
    <p class="subtitle">Manage your account information</p>

    <!-- Profile Information Card -->
    <div class="form-card">
      <h2>Account Information</h2>
      <div class="form-group">
        <label>Email</label>
        <input id="profileEmail" type="email" placeholder="your@email.com" readonly style="background: #f5f5f5;">
        <small style="color: #64748b;">Email cannot be changed</small>
      </div>
      <div class="form-group">
        <label>Username</label>
        <input id="profileUsername" type="text" placeholder="Your username">
      </div>
      <button id="updateProfileBtn" class="btn-primary">Update Profile</button>
      <p id="profileMsg" class="message"></p>
    </div>

    <!-- Change Password Card -->
    <div class="form-card" style="margin-top: 24px;">
      <h2>Change Password</h2>
      <div class="form-group">
        <label>Current Password</label>
        <input id="currentPassword" type="password" placeholder="Enter current password">
      </div>
      <div class="form-group">
        <label>New Password</label>
        <input id="newPassword" type="password" placeholder="Enter new password (min 6 characters)">
      </div>
      <div class="form-group">
        <label>Confirm New Password</label>
        <input id="confirmPassword" type="password" placeholder="Confirm new password">
      </div>
      <button id="changePasswordBtn" class="btn-primary">Change Password</button>
      <p id="passwordMsg" class="message"></p>
    </div>

    <!-- Account Stats Card -->
    <div class="form-card" style="margin-top: 24px;">
      <h2>Account Statistics</h2>
      <div class="stats-grid">
        <div class="stat-card">
          <h3 id="totalExpenses">0</h3>
          <p>Total Expenses</p>
        </div>
        <div class="stat-card">
          <h3 id="totalSpent">$0.00</h3>
          <p>Total Spent</p>
        </div>
        <div class="stat-card">
          <h3 id="categoriesUsed">0</h3>
          <p>Categories Used</p>
        </div>
      </div>
    </div>
  </main>

  <script src="api-service.js"></script>
  
  <script>
    if (!requireAuth()) {
      // Redirects if not authenticated
    }

    // Check if user is admin and show admin link
    async function checkAdminRole() {
      try {
        const result = await API.auth.getCurrentUser();
        if (result.success && result.data.user.role === 'admin') {
          document.getElementById('adminLink').style.display = 'inline-block';
        }
      } catch (error) {
        console.error('Error checking admin role:', error);
      }
    }
    checkAdminRole();

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async function() {
      await API.auth.logout();
      window.location.href = 'index.html';
    });

    // Load current user data
    async function loadProfile() {
      try {
        const result = await API.auth.getCurrentUser();
        
        if (result.success && result.data.user) {
          const user = result.data.user;
          document.getElementById('profileEmail').value = user.email;
          document.getElementById('profileUsername').value = user.username;
        }

        // Load account stats
        const expensesResult = await API.expenses.getAll();
        if (expensesResult.success) {
          const expenses = expensesResult.data.expenses;
          const total = expenses.reduce((sum, exp) => sum + exp.amount, 0);
          const categories = [...new Set(expenses.map(exp => exp.category))];
          
          document.getElementById('totalExpenses').textContent = expenses.length;
          document.getElementById('totalSpent').textContent = `$${total.toFixed(2)}`;
          document.getElementById('categoriesUsed').textContent = categories.length;
        }
      } catch (error) {
        console.error('Error loading profile:', error);
      }
    }

    // Update profile
    document.getElementById('updateProfileBtn').addEventListener('click', async function() {
      const username = document.getElementById('profileUsername').value.trim();
      const email = document.getElementById('profileEmail').value.trim();
      const msgEl = document.getElementById('profileMsg');

      if (!username) {
        msgEl.textContent = 'Please enter a username';
        msgEl.className = 'message error';
        return;
      }

      if (username.length < 3 || username.length > 30) {
        msgEl.textContent = 'Username must be 3-30 characters';
        msgEl.className = 'message error';
        return;
      }

      try {
        const btn = this;
        btn.disabled = true;
        btn.textContent = 'Updating...';

        const result = await API.auth.updateProfile({ username, email });

        if (result.success) {
          msgEl.textContent = 'Profile updated successfully!';
          msgEl.className = 'message success';
        } else {
          msgEl.textContent = result.message || 'Failed to update profile';
          msgEl.className = 'message error';
        }

        btn.disabled = false;
        btn.textContent = 'Update Profile';
      } catch (error) {
        msgEl.textContent = 'Error: ' + error.message;
        msgEl.className = 'message error';
        this.disabled = false;
        this.textContent = 'Update Profile';
      }
    });

    // Change password
    document.getElementById('changePasswordBtn').addEventListener('click', async function() {
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      const msgEl = document.getElementById('passwordMsg');

      if (!currentPassword || !newPassword || !confirmPassword) {
        msgEl.textContent = 'Please fill in all password fields';
        msgEl.className = 'message error';
        return;
      }

      if (newPassword.length < 6) {
        msgEl.textContent = 'New password must be at least 6 characters';
        msgEl.className = 'message error';
        return;
      }

      if (newPassword !== confirmPassword) {
        msgEl.textContent = 'New passwords do not match';
        msgEl.className = 'message error';
        return;
      }

      try {
        const btn = this;
        btn.disabled = true;
        btn.textContent = 'Changing...';

        const result = await API.auth.changePassword({ currentPassword, newPassword });

        if (result.success) {
          msgEl.textContent = 'Password changed successfully!';
          msgEl.className = 'message success';
          
          // Clear password fields
          document.getElementById('currentPassword').value = '';
          document.getElementById('newPassword').value = '';
          document.getElementById('confirmPassword').value = '';
        } else {
          msgEl.textContent = result.message || 'Failed to change password';
          msgEl.className = 'message error';
        }

        btn.disabled = false;
        btn.textContent = 'Change Password';
      } catch (error) {
        msgEl.textContent = 'Error: ' + error.message;
        msgEl.className = 'message error';
        this.disabled = false;
        this.textContent = 'Change Password';
      }
    });

    // Load profile on page load
    loadProfile();
  </script>
</body>
</html>
