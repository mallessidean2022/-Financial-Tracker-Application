<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>FinTrack – Expenses</title>
  <link rel="stylesheet" href="styles.css">
</head>

<body>
  <nav class="navbar">
    <div class="nav-brand">
      <div class="logo">FT</div>
      <span>FinTrack</span>
    </div>
    <div class="nav-links">
      <a href="dashboard.html">Dashboard</a>
      <a href="expenses.html" class="active">Expenses</a>
      <a href="reports.html">Reports</a>
      <a href="categories.html">Categories</a>
      <a href="profile.html">Profile</a>
      <a href="admin-dashboard.html" id="adminLink" style="display: none; background: #f59e0b; color: white;">⚙️ Admin Panel</a>
      <button id="logoutBtn" class="btn-secondary" style="margin-left: auto;">Logout</button>
    </div>
  </nav>

  <main class="container">
    <h1>Manage Expenses</h1>

    <!-- Add/Edit Expense Form -->
    <div class="form-card">
      <h2 id="formTitle">Add New Expense</h2>
      <input type="hidden" id="editingId" value="">
      <div class="form-group">
        <label>Amount ($)</label>
        <input id="expAmount" type="number" step="0.01" placeholder="0.00">
      </div>
      <div class="form-group">
        <label>Description</label>
        <input id="expDesc" type="text" placeholder="What was this expense for?">
      </div>
      <div class="form-group">
        <label>Category</label>
        <select id="expCategory">
          <option value="">Loading categories...</option>
        </select>
      </div>
      <div class="form-group">
        <label>Date</label>
        <input id="expDate" type="date">
      </div>
      <div style="display: flex; gap: 10px;">
        <button id="addExpBtn" class="btn-primary">Add Expense</button>
        <button id="cancelEditBtn" class="btn-secondary" style="display: none;">Cancel</button>
      </div>
      <p id="addMsg" class="message"></p>
    </div>

    <!-- Filter Section -->
    <div class="filter-section">
      <h2>Filter Expenses</h2>
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
        <div class="form-group">
          <label>Category</label>
          <select id="filterCategory">
            <option value="">All Categories</option>
            <option value="grocery">Grocery</option>
            <option value="gas">Gas</option>
            <option value="bills">Bills</option>
            <option value="shopping">Shopping</option>
            <option value="entertainment">Entertainment</option>
            <option value="dining">Dining</option>
            <option value="transportation">Transportation</option>
            <option value="healthcare">Healthcare</option>
            <option value="utilities">Utilities</option>
            <option value="other">Other</option>
          </select>
        </div>
        <div class="form-group">
          <label>Start Date</label>
          <input id="filterStartDate" type="date">
        </div>
        <div class="form-group">
          <label>End Date</label>
          <input id="filterEndDate" type="date">
        </div>
      </div>
      <button id="filterBtn" class="btn-secondary">Apply Filters</button>
      <button id="clearBtn" class="btn-secondary">Clear Filters</button>
    </div>

    <!-- Expenses List -->
    <h2>Your Expenses</h2>
    <div id="expensesList" class="expense-list"></div>
  </main>

  <!-- Load API service first -->
  <script src="api-service.js"></script>
  
  <script>
    // Require authentication
    if (!requireAuth()) {
      // Redirects if not authenticated
    }

    // Check if user is admin and show admin link
    async function checkAdminRole() {
      try {
        const result = await API.auth.getCurrentUser();
        if (result.success && result.data.user.role === 'admin') {
          document.getElementById('adminLink').style.display = 'inline-block';
        }
      } catch (error) {
        console.error('Error checking admin role:', error);
      }
    }
    checkAdminRole();

    // Load categories dynamically
    async function loadCategories() {
      try {
        const result = await API.categories.getAll();
        const categorySelect = document.getElementById('expCategory');
        const filterCategorySelect = document.getElementById('filterCategory');
        
        if (result.success && result.data.categories) {
          const categories = result.data.categories;
          
          // Populate main category dropdown
          categorySelect.innerHTML = categories.map(cat => 
            `<option value="${cat.name.toLowerCase()}">${cat.name.charAt(0).toUpperCase() + cat.name.slice(1)}</option>`
          ).join('');
          
          // Populate filter category dropdown
          filterCategorySelect.innerHTML = '<option value="">All Categories</option>' + 
            categories.map(cat => 
              `<option value="${cat.name.toLowerCase()}">${cat.name.charAt(0).toUpperCase() + cat.name.slice(1)}</option>`
            ).join('');
        } else {
          // Fallback to default categories if API fails
          categorySelect.innerHTML = `
            <option value="grocery">Grocery</option>
            <option value="bills">Bills</option>
            <option value="dining">Dining</option>
            <option value="gas">Gas</option>
            <option value="shopping">Shopping</option>
            <option value="entertainment">Entertainment</option>
            <option value="transportation">Transportation</option>
            <option value="healthcare">Healthcare</option>
            <option value="utilities">Utilities</option>
            <option value="other">Other</option>
          `;
        }
      } catch (error) {
        console.error('Error loading categories:', error);
      }
    }
    
    loadCategories();

    // Set today's date as default (in local timezone)
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    const todayString = `${year}-${month}-${day}`;
    document.getElementById('expDate').value = todayString;

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async function() {
      await API.auth.logout();
      window.location.href = 'index.html';
    });

    // Add/Update expense
    document.getElementById('addExpBtn').addEventListener('click', async function() {
      const amount = parseFloat(document.getElementById('expAmount').value);
      const description = document.getElementById('expDesc').value.trim();
      const category = document.getElementById('expCategory').value;
      const date = document.getElementById('expDate').value;
      const editingId = document.getElementById('editingId').value;
      const msgEl = document.getElementById('addMsg');

      if (!amount || amount <= 0) {
        msgEl.textContent = 'Please enter a valid amount';
        msgEl.className = 'message error';
        return;
      }

      if (!description) {
        msgEl.textContent = 'Please enter a description';
        msgEl.className = 'message error';
        return;
      }

      if (!date) {
        msgEl.textContent = 'Please select a date';
        msgEl.className = 'message error';
        return;
      }

      try {
        const btn = this;
        btn.disabled = true;
        
        let result;
        
        // Prepare date - ensure it's stored as noon UTC to avoid timezone issues
        let expenseDate = date;
        if (date && !date.includes('T')) {
          // If date is just YYYY-MM-DD, set it to noon UTC
          expenseDate = date + 'T12:00:00.000Z';
        }
        
        if (editingId) {
          // Update existing expense
          btn.textContent = 'Updating...';
          result = await API.expenses.update(editingId, { amount, description, category, date: expenseDate });
        } else {
          // Create new expense
          btn.textContent = 'Adding...';
          result = await API.expenses.create({ amount, description, category, date: expenseDate });
        }

        if (result.success) {
          msgEl.textContent = editingId ? 'Expense updated successfully!' : 'Expense added successfully!';
          msgEl.className = 'message success';
          
          // Clear form (this handles button reset)
          clearForm();
          
          // Reload list
          loadExpenses();
        } else {
          msgEl.textContent = result.message || 'Failed to save expense';
          msgEl.className = 'message error';
          btn.disabled = false;
          // Keep button text as is for retry
        }
      } catch (error) {
        msgEl.textContent = 'Error: ' + error.message;
        msgEl.className = 'message error';
        this.disabled = false;
        // Keep button text as is for retry
      }
    });

    // Cancel edit
    document.getElementById('cancelEditBtn').addEventListener('click', function() {
      clearForm();
    });

    // Clear form function
    function clearForm() {
      document.getElementById('expAmount').value = '';
      document.getElementById('expDesc').value = '';
      const today = new Date();
      const year = today.getFullYear();
      const month = String(today.getMonth() + 1).padStart(2, '0');
      const day = String(today.getDate()).padStart(2, '0');
      document.getElementById('expDate').value = `${year}-${month}-${day}`;
      document.getElementById('editingId').value = '';
      document.getElementById('formTitle').textContent = 'Add New Expense';
      const btn = document.getElementById('addExpBtn');
      btn.textContent = 'Add Expense';
      btn.disabled = false; // Re-enable button
      document.getElementById('cancelEditBtn').style.display = 'none';
      document.getElementById('addMsg').textContent = '';
    }

    // Edit expense function
    function editExpense(id, amount, description, category, date) {
      document.getElementById('editingId').value = id;
      document.getElementById('expAmount').value = amount;
      document.getElementById('expDesc').value = description;
      document.getElementById('expCategory').value = category;
      document.getElementById('expDate').value = date.split('T')[0];
      document.getElementById('formTitle').textContent = 'Edit Expense';
      document.getElementById('addExpBtn').textContent = 'Update Expense';
      document.getElementById('cancelEditBtn').style.display = 'inline-block';
      
      // Scroll to form
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // Load expenses
    async function loadExpenses(filters = {}) {
      try {
        const result = await API.expenses.getAll(filters);
        
        if (result.success) {
          const expenses = result.data.expenses;
          
          if (expenses.length === 0) {
            document.getElementById('expensesList').innerHTML = '<p>No expenses found</p>';
            return;
          }

          const html = expenses.map(exp => {
            // Get the date string in YYYY-MM-DD format from backend
            const dateStr = exp.date.split('T')[0]; // Just take the date part, ignore time
            const [year, month, day] = dateStr.split('-');
            const displayDate = `${month}/${day}/${year}`;
            
            return `
            <div class="expense-item">
              <div>
                <strong>$${exp.amount.toFixed(2)}</strong> - ${exp.description}
              </div>
              <small style="text-transform: capitalize;">${exp.category} · ${displayDate}</small>
              <div style="margin-top: 8px;">
                <button onclick="editExpense('${exp._id}', ${exp.amount}, '${exp.description.replace(/'/g, "\\'")}', '${exp.category}', '${exp.date}')" class="btn-secondary btn-sm">Edit</button>
                <button onclick="deleteExpense('${exp._id}')" class="btn-danger btn-sm">Delete</button>
              </div>
            </div>
          `}).join('');
          
          document.getElementById('expensesList').innerHTML = html;
        }
      } catch (error) {
        console.error('Error loading expenses:', error);
        document.getElementById('expensesList').innerHTML = 
          '<p class="error">Error loading expenses. Make sure backend is running!</p>';
      }
    }

    // Delete expense
    async function deleteExpense(id) {
      if (!confirm('Are you sure you want to delete this expense?')) {
        return;
      }

      try {
        const result = await API.expenses.delete(id);
        if (result.success) {
          loadExpenses();
        }
      } catch (error) {
        alert('Error deleting expense: ' + error.message);
      }
    }

    // Filter expenses
    document.getElementById('filterBtn').addEventListener('click', function() {
      const filters = {};
      
      const category = document.getElementById('filterCategory').value;
      if (category) filters.category = category;
      
      const startDate = document.getElementById('filterStartDate').value;
      if (startDate) {
        // Ensure date is sent with time to avoid timezone issues
        filters.startDate = startDate + 'T00:00:00.000Z';
      }
      
      const endDate = document.getElementById('filterEndDate').value;
      if (endDate) {
        // Set to end of day
        filters.endDate = endDate + 'T23:59:59.999Z';
      }
      
      loadExpenses(filters);
    });

    // Clear filters
    document.getElementById('clearBtn').addEventListener('click', function() {
      document.getElementById('filterCategory').value = '';
      document.getElementById('filterStartDate').value = '';
      document.getElementById('filterEndDate').value = '';
      loadExpenses();
    });

    // Load on page load
    loadExpenses();
  </script>
</body>
</html>
